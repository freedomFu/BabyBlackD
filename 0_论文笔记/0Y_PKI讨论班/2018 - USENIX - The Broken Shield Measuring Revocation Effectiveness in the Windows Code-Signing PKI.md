### 摘要

近期评估的研究表明代码签名PKI存在安全威胁，比如证书已经被破坏了或者签发给了恶意软件的作者。当前抵抗这种威胁主要方法是撤销被滥用的证书。但是当前代码签名PKI的现状使评估撤销的有效性非常困难。当前签名的恶意软件的威胁没有被完全理解。作者通过收集7个数据集从端到端分析撤销过程。有效的撤销过程依赖于三部分：

1. 发现被滥用的证书
2. 有效撤销证书
3. 将撤销信息散播给客户端

评估了发现被破坏的证书和撤销延迟的挑战。展示了错误设置撤销日期可能会导致签名的恶意软件在证书撤销后仍然有效。

### 1. Introduction

通过代码签名，PKI使软件发行者可以给可执行程序签名，也可以将签名密钥的证书绑定到发行者实体上。客户端可以验证证书并检查发布者来确认第三方程序的完整性避免执行恶意代码。通用安全策略是信任那些由可信发布者有效签名的可执行程序，前提就是签名密钥不是由恶意敌手控制的。

在Windows代码签名的生态系统中，许多证书被破坏或者直接签发给了恶意软件作者。当出现了证书的滥用，最好的方法就是撤销，但根据之前web PKI的相关研究，可以知道一些问题：较长的撤销时延、散播撤销信息时的较大的带宽消耗以及客户端可能不检验证书是否被撤销。但是在代码签名领域，这些则处于一个未知状态，如何进行有效的撤销仍然是一个大问题。

代码签名使用的仍然是一种默认有效的信任模型，也就是至少证书链没有被证明是有问题的就是可信的。所以丢失或者延迟的撤销都可能使证书被滥用去给可执行程序签名，而只有证书真正过期或者撤销才不会被利用。

**另外与web PKI不同，在代码签名领域，过期时间的处理是不同的。**为了避免重新签名及分发二进制文件，当签名证书过期的时候，Windows开发人员会通过包含一个可信的时间戳来延长有效期，时间戳由 *Time-Stamping Authority (TSA)*，它可以认证二进制文件的签名时间。如果恶意文件是在证书过期之前签名并且时间戳化的话，那么当证书过期的时候，这个文件的签名仍然是有效的，除非这个证书被撤销了。这意味着即使对于过期的证书，有效的撤销仍然是必要的。

*signed malware* 和 *potentially unwanted programs(PUP)* 

**一个有效的撤销过程包含以下三个方面：**

1. 发现被破坏的或者被恶意人员控制的证书
2. 有效撤销这些证书
3. 发布撤销信息

****

**如何发现有问题的证书呢？**

对于web PKI来说，有问题的证书可以通过网络扫描获取。但是对于代码签名问题来说，需要找到签名的恶意软件或PUP的样例或者主机来进行研究。而这种情况导致了进行这种查询过程的安全公司可能无法找到所有证书应用的软件，也就无法知道这些被用于签发恶意软件的证书究竟有多少，这也导致了对于撤销需求的不正确认知。即使是找到了一个签名的恶意软件，我们也无法确定证书应该撤销的具体日期：因为 `Hard revocations`会将该证书整个生命周期签名的软件都变得无效，而 `Soft revocations`可以通过设置一个签署日期之后的撤销日期，这可能会遗漏一些恶意软件。另外，CA也需要维护一个撤销的机制以便撤销信息可以分发给客户端，否则撤销证书就变得不那么重要。

这些挑战使代码签名生态系统变得难以审计，这使得这些无效撤销导致的安全威胁难以正确评估。

---

本文提供了一种端到端的对代码签名证书撤销的评估方案。

- 当前撤销过程从发现到传播消息的有效性，以及如果这些过程做得不好会引入什么安全威胁 `since there is no official repository for code signing certificates` 作者使用了之前研究的数据集并增加了Symantec的资源库
- 从数据集中取出了145582个`unique`的叶子证书，并且从这些证书中拿到了215个只用于代码签名证书的CRL，以及131个OCSP点。
- 周期性地探寻这些CRL来检查它们的状态来收集撤销发布日期（即证书被CA撤销且撤销信息被发布的日期）

通过分析，在上述的三个方面总结了9个发现。

![image](https://user-images.githubusercontent.com/40269368/159103040-e52ebbca-09ea-486f-9228-055f5168161e.png)

本文的贡献

1. 收集了大量的代码签名证书和撤销信息
2. 第一个对代码签名证书撤销过程的端到端的评估
3. 使用数据评估了有问题证书数量的下界
4. 从撤销过程的三个部分将问题分类并发现了一些新的问题
5. 讨论并提出了一些改进的建议

## 2. Problem Statement

在介绍研究结果之前，作者首先介绍了证书撤销在代码签名PKI中的特殊地位，讨论它的实现以及探索撤销有效性的研究问题。

### 2.1 Code Signing PKI

代码签名提供了对软件发布者可鉴别性和二进制可执行文件的完整性。

**代码签名过程。**软件发布者向CA请求代码签名证书并使用证书给二进制文件签名。在此过程中会先计算哈希值，哈希值被私钥签名，然后源码与签名绑定在一起。终端用户检查签名证书的有效性，后续会周期性检查以便确定证书是有效的。

**Microsoft鉴别码。**在Windows中，Authenticode是为Windows文件签名的标准，一般情况下，这些文件中会存储着代码签名证书链、时间戳证书链、数字签名和PE文件的哈希值，没有加密信息。

**可信时间戳。**代码签名PKI提供了可信时间戳 *trusted timestamping.* 这种方案是用于证明代码是在特定的日期和时间签名的，时间戳信息是由 Time Stamping Authority (TSA) 在签名过程中签发并签名的。这个信息可以表明签名是在证书有效期内签发的，可以在证书过期之后延长对于签名程序的信任。但是恶意软件也可以通过这样的方式攻击，这使得即使证书过期后，这个恶意软件仍然是有效的。

**Trends of code signing abuse代码签名滥用的趋势.**数字签名后的恶意软件可以帮助它们去绕过一些保护机制，比如Windows账户控制(Windows’ User Account Control, UAC)和抗病毒驱动(Anti-Virus, AV)。所以，敌手可以通过盗窃或者虚假证书给恶意软件签名，比如说Stuxnet, Flame, Duqu. Kim等人的研究给出了威胁模型提出了代码签名PKI的问题：客户端保护的不充分、发布者密钥的不良管理和CA端的验证失败。这三点会使Windows代码签名PKI遭受破坏。恶意软件发布者会通过黑色交易链来购买这些代码签名证书。而且，大概60%的有问题的证书在签发一个月内就开始给恶意软件签名了，这也表明证书是为了滥用而签发是逐渐流行的。

### 2.2 Revocation Process

证书撤销是抵抗代码签名滥用的主要防御方法。CA负责撤销证书，比如私钥被公开了、实体不可信了、证书被错误签发了或者证书给恶意软件签名了…。撤销过程包含三步：找到有问题的证书、执行有效的撤销并散播撤销信息。

**找到可能错误的证书。**谁负责发现错误的证书？证书滥用的声明通常来自杀毒公司，持有这些证书公司或研究人员。一旦被通报，证书的签发者应该积极调查并撤销被滥用的证书。从发现$t_d$到撤销信息被公开$t_p$的时延应该尽可能短$t_p-t_d$，过期时间$t_e$。由于可信时间戳机制，即使是证书过期了，也应该被撤销。

<img width="642" alt="image" src="https://user-images.githubusercontent.com/40269368/159105219-10817d1d-3595-4ca1-b464-6c66e164be28.png">

**设置撤销日期。**如果CA确定存在一个滥用的问题，由于可信时间戳的存在，它们需要确定一个有效撤销时间$t_r$。有效撤销时间可以决定哪些二进制文件有问题。只要在某个检测时间$t_d$看到了证书，就需要被撤销。然而，在$t_r$之前签发的证书仍然是有效的。

**撤销信息的发布。**CA需要发布撤销信息，一般通过CRL或OSCP。

- CRL包含已被撤销证书的信息，而CRL的信息是基于CA签发策略更新的，可能定期也可能伴随某个事件的发生。客户端通过下载CRL来获取信息。
- OCSP是为了解决网络负载的问题引入的，客户端可以直接查询OCSP来得到证书的信息。AIA。

注意TLS的CA不负责给过期证书提供撤销状态，但是代码签名证书必须要提供这个信息。因为可信时间戳的存在，CA需要维护CRL和OCSP来使客户端可以获取到撤销信息。**这里需要注意，撤销信息是客户端应该可以获取到的。**

### 2.3 Effectiveness of Revocation Process

**1. How many certificates are being used to sign malware?**



**2. How prompt is the revocation process?**



**3. Are effective revocation dates set properly?**



**4. Is revocation information served properly?**

### 2.4 Our Goal and Non-Goal



### 2.5 Challenges for Measuring Revocation



## 3. Data Collection

### 3.1 Fundamental Data



### 3.2 Revocation Publication Date List



### 3.3 Binary Sample Information



### 3.4 CRL/OCSP Reachability History



## 4. Discovery of Potentially Compromised Certificates

### 4.1 Mark-recapture Population Estimation



### 4.2 Revocation Delay



## 5 Setting the Revocation Date

### 5.1 Problems in Revocation Date Setting





## 6 Dissemination of Revocation Information

### 6.1 Enforcement in Windows



### 6.2 Unavailable Revocation Information



### 6.3 Mismanagement in CRLs and OCSPs



## 7 Limitation





## 8 Discussion



## 9 Related Work



## 10 Conclusion

证书撤销仍然是当前抵抗代码签名滥用的主要防御方法，包含上文所说的三个方面，找到有问题的证书、在合理的时间撤销并将撤销信息散播出去。本文发现这个过程存在问题，而且这些安全问题会引入新的安全威胁。例如，CA平均要花费5.6个月的时间来撤销一个给恶意软件签名的证书，标记重捕技术(mark-recapture)评估的方法也展示出在实际中找到这些被滥用的证书是困难的。签名的有效性由撤销日期决定，但是CA可能设置了错误的撤销日期，导致证书撤销之后这个软件仍然有效。另外CRL和OCSP的部署不规范也可能导致攻击，作者发现客户端在很多情况下都不检查证书的撤销状态，比如说没有CRL或者OCSP点，无法访问这些信息，CRL不再更新了，或者撤销的证书被错误地从其中移除了，CRL和OCSP信息的不一致性或者未知、未授权的OCSP响应。