### 摘要

近期评估的研究表明代码签名PKI存在安全威胁，比如证书已经被破坏了或者签发给了恶意软件的作者。当前抵抗这种威胁主要方法是撤销被滥用的证书。但是当前代码签名PKI的现状使评估撤销的有效性非常困难。当前签名的恶意软件的威胁没有被完全理解。作者通过收集7个数据集从端到端分析撤销过程。有效的撤销过程依赖于三部分：

1. 发现被滥用的证书
2. 有效撤销证书
3. 将撤销信息散播给客户端

评估了发现被破坏的证书和撤销延迟的挑战。展示了错误设置撤销日期可能会导致签名的恶意软件在证书撤销后仍然有效。

![image](https://user-images.githubusercontent.com/40269368/160308837-0979adde-0a5d-468c-8525-f2521e0ae790.png)

### 1. Introduction

通过代码签名，PKI使软件发行者可以给可执行程序签名，也可以将签名密钥的证书绑定到发行者实体上。客户端可以验证证书并检查发布者来确认第三方程序的完整性避免执行恶意代码。通用安全策略是信任那些由可信发布者有效签名的可执行程序，前提就是签名密钥不是由恶意敌手控制的。

在Windows代码签名的生态系统中，许多证书被破坏或者直接签发给了恶意软件作者。当出现了证书的滥用，最好的方法就是撤销，但根据之前web PKI的相关研究，可以知道一些问题：较长的撤销时延、散播撤销信息时的较大的带宽消耗以及客户端可能不检验证书是否被撤销。但是在代码签名领域，这些则处于一个未知状态，如何进行有效的撤销仍然是一个大问题。

代码签名使用的仍然是一种默认有效的信任模型，也就是至少证书链没有被证明是有问题的就是可信的。所以丢失或者延迟的撤销都可能使证书被滥用去给可执行程序签名，而只有证书真正过期或者撤销才不会被利用。 *这里与web PKI的区分是什么呢？*

**另外与web PKI不同，在代码签名领域，过期时间的处理是不同的。**为了避免重新签名及分发二进制文件，当签名证书过期的时候，Windows开发人员会通过包含一个可信的时间戳来延长有效期，时间戳由 *Time-Stamping Authority (TSA)*，它可以认证二进制文件的签名时间。如果恶意文件是在证书过期之前签名并且时间戳化的话，那么当证书过期的时候，这个文件的签名仍然是有效的，除非这个证书被撤销了。这意味着即使对于过期的证书，有效的撤销仍然是必要的。

*signed malware* 和 *potentially unwanted programs(PUP)* 

**一个有效的撤销过程包含以下三个方面：**

1. 发现被破坏的或者被恶意人员控制的证书
2. 有效撤销这些证书
3. 发布撤销信息

****

**如何发现有问题的证书呢？**

对于web PKI来说，有问题的证书可以通过网络扫描获取。但是对于代码签名问题来说，需要找到签名的恶意软件或PUP的样例或者主机来进行研究。而这种情况导致了进行这种查询过程的安全公司可能无法找到所有证书应用的软件，也就无法知道这些被用于签发恶意软件的证书究竟有多少，这也导致了对于撤销需求的不正确认知。即使是找到了一个签名的恶意软件，我们也无法确定证书应该撤销的具体日期：因为 `Hard revocations`会将该证书整个生命周期签名的软件都变得无效，而 `Soft revocations`可以通过设置一个签署日期之后的撤销日期，这可能会遗漏一些恶意软件。另外，CA也需要维护一个撤销的机制以便撤销信息可以分发给客户端，否则撤销证书就变得不那么重要。

这些挑战使代码签名生态系统变得难以审计，这使得这些无效撤销导致的安全威胁难以正确评估。

---

本文提供了一种端到端的对代码签名证书撤销的评估方案。

- 当前撤销过程从发现到传播消息的有效性，以及如果这些过程做得不好会引入什么安全威胁 `since there is no official repository for code signing certificates` 作者使用了之前研究的数据集并增加了Symantec的资源库
- 从数据集中取出了145582个`unique`的叶子证书，并且从这些证书中拿到了215个只用于代码签名证书的CRL，以及131个OCSP点。
- 周期性地探寻这些CRL来检查它们的状态来收集撤销发布日期（即证书被CA撤销且撤销信息被发布的日期）

通过分析，在上述的三个方面总结了9个发现。

![image](https://user-images.githubusercontent.com/40269368/159103040-e52ebbca-09ea-486f-9228-055f5168161e.png)

本文的贡献

1. 收集了大量的代码签名证书和撤销信息
2. 第一个对代码签名证书撤销过程的端到端的评估
3. 使用数据评估了有问题证书数量的下界
4. 从撤销过程的三个部分将问题分类并发现了一些新的问题
5. 讨论并提出了一些改进的建议

## 2. Problem Statement

在介绍研究结果之前，作者首先介绍了证书撤销在代码签名PKI中的特殊地位，讨论它的实现以及探索撤销有效性的研究问题。

### 2.1 Code Signing PKI

代码签名提供了对软件发布者可鉴别性和二进制可执行文件的完整性。

**代码签名过程。**软件发布者向CA请求代码签名证书并使用证书给二进制文件签名。在此过程中会先计算哈希值，哈希值被私钥签名，然后源码与签名绑定在一起。终端用户检查签名证书的有效性，后续会周期性检查以便确定证书是有效的。

**Microsoft鉴别码。**在Windows中，Authenticode是为Windows文件签名的标准，一般情况下，这些文件中会存储着代码签名证书链、时间戳证书链、数字签名和PE文件的哈希值，没有加密信息。

**可信时间戳。**代码签名PKI提供了可信时间戳 *trusted timestamping.* 这种方案是用于证明代码是在特定的日期和时间签名的，时间戳信息是由 Time Stamping Authority (TSA) 在签名过程中签发并签名的。这个信息可以表明签名是在证书有效期内签发的，可以在证书过期之后延长对于签名程序的信任。但是恶意软件也可以通过这样的方式攻击，这使得即使证书过期后，这个恶意软件仍然是有效的。

**Trends of code signing abuse代码签名滥用的趋势.**数字签名后的恶意软件可以帮助它们去绕过一些保护机制，比如Windows账户控制(Windows’ User Account Control, UAC)和抗病毒驱动(Anti-Virus, AV)。所以，敌手可以通过盗窃或者虚假证书给恶意软件签名，比如说Stuxnet, Flame, Duqu. Kim等人的研究给出了威胁模型提出了代码签名PKI的问题：客户端保护的不充分、发布者密钥的不良管理和CA端的验证失败。这三点会使Windows代码签名PKI遭受破坏。恶意软件发布者会通过黑色交易链来购买这些代码签名证书。而且，大概60%的有问题的证书在签发一个月内就开始给恶意软件签名了，这也表明证书是为了滥用而签发是逐渐流行的。

### 2.2 Revocation Process

证书撤销是抵抗代码签名滥用的主要防御方法。CA负责撤销证书，比如私钥被公开了、实体不可信了、证书被错误签发了或者证书给恶意软件签名了…。撤销过程包含三步：找到有问题的证书、执行有效的撤销并散播撤销信息。

**找到可能错误的证书。**谁负责发现错误的证书？证书滥用的声明通常来自杀毒公司，持有这些证书公司或研究人员。一旦被通报，证书的签发者应该积极调查并撤销被滥用的证书。从发现$t_d$到撤销信息被公开$t_p$的时延应该尽可能短$t_p-t_d$，过期时间$t_e$。由于可信时间戳机制，即使是证书过期了，也应该被撤销。

<img width="642" alt="image" src="https://user-images.githubusercontent.com/40269368/159105219-10817d1d-3595-4ca1-b464-6c66e164be28.png">

**设置撤销日期。**如果CA确定存在一个滥用的问题，由于可信时间戳的存在，它们需要确定一个有效撤销时间$t_r$。有效撤销时间可以决定哪些二进制文件有问题。只要在某个检测时间$t_d$看到了证书，就需要被撤销。然而，在$t_r$之前签发的证书仍然是有效的。

**撤销信息的发布。**CA需要发布撤销信息，一般通过CRL或OSCP。

- CRL包含已被撤销证书的信息，而CRL的信息是基于CA签发策略更新的，可能定期也可能伴随某个事件的发生。客户端通过下载CRL来获取信息。
- OCSP是为了解决网络负载的问题引入的，客户端可以直接查询OCSP来得到证书的信息。AIA。

注意TLS的CA不负责给过期证书提供撤销状态，但是代码签名证书必须要提供这个信息。因为可信时间戳的存在，CA需要维护CRL和OCSP来使客户端可以获取到撤销信息。**这里需要注意，撤销信息是客户端应该可以获取到的。**

### 2.3 Effectiveness of Revocation Process

**1. How many certificates are being used to sign malware?**

撤销过程从发现错误证书开始，作者从评估当前威胁的规模开始。

**2. How prompt is the revocation process?**

根据研究，当有证书问题时，CA必须要在24小时内调查报道，撤销错误证书并且在7天发布撤销信息或者从证书持有者那里得到合理的原因。撤销信息公之于众的时间为$t_p$，当前许多信息是杀毒公司来揭露的，也因为一些特定的组织本身的原因，从出现问题到揭露问题是存在一个延迟的。

**3. Are effective revocation dates set properly?**

撤销日期$t_r$，是因为可信时间戳而产生的，所有在此时间之前的证书都被认为是可信的，而之后的则是不可信的。对于 *hard revocation* $t_r=t_i$，而 *soft revocation* $t_i ＜ t_r ≤t_e$。两者都有优缺点，*hard*可以使所有软件都不可信，但是可能会误伤，而 *soft*会尽可能匹配证书真正出问题的时间，但是如果时间设置的不对，则仍然可能存在一些恶意软件被信任。

**4. Is revocation information served properly?**

客户端平台会检查叶子和中间证书的有效性，但是根据说明，一个二进制文件如果不可能检查撤销状态就应该认为是没有被签名的。  *According to the specification [3], a binary should be considered unsigned when it is not possible to check the revocation status.*

如果客户端不遵循这个说明，而是用`soft-fail`撤销验证策略，即当不存在撤销信息时信任证书。如果这样的话，若撤销状态信息不可用，则撤销证书对应的软件仍然认为是有效的。所以应检查撤销信息是否由CA维护和发放。

### 2.4 Our Goal and Non-Goal

文章的目标系统地评估撤销过程的问题和由这些问题引入的新的威胁。**非目标(non-goals)**包括充分描述 ① CA内部结构问题 ② 内部撤销策略 ③ Windows平台的内部撤销验证策略

*不在考虑范围内？*

### 2.5 Challenges for Measuring Revocation

评估代码签名撤销过程的挑战是： visibility & timing

- **visibility**  没有简单的方法来找到所有的证书。所以作者需要从资源库中尽可能找到数据
- **timing** 作者只看了一个版本的CRL，只能看到撤销时间 $t_r$，我们只能知道哪些文件是不可信的，但是不能知道这个信任是什么时候丢失的。而为了找到撤销发布日期$t_p$，证书在撤销列表中，我们只能长期动态的监视CRL。

## 3. Data Collection

数据收集方法。

### 3.1 Fundamental Data (D1 - D2)

需要收集代码签名证书可以得到其他的信息，比如CRL和OCSP以及其他的信息。

![image](https://user-images.githubusercontent.com/40269368/159109171-9a637f9e-ae76-4d53-8be0-25c265b85fc1.png)

**Code signing certificates(D1).** 在实际中，没有对代码签名证书的大型公共的数据库，作者使用了先前研究使用的数据及以及一些专门的二进制文件的资源库。数据集包括：

1. Malsign.  研究人员评估了签名的恶意PE文件，并公开发布了2171个叶子代码签名证书。
2. Malcert.  研究人员检查了330万个从私有公司收集的内容，并分享了801995个签名的PE文件。数量锐减的原因是大多数文件是重复使用的，用于签名带有不同哈希值的二进制文件。
3. Symantec data set.  该公司有一个内部的二进制文件的资源库，收集到了149840个用例。
4. Samples from WINE and VirusTotal. 对于每个来自WINE的CA收集到了大约300个文件，并且从VirusTotal下载了许多实例；收集到了11108个PE文件。3.3节。

PKCS#7文件包含的内容有：代码签名证书链、TSA证书链、签名和PE文件的哈希值。除了`Malsign`之外（只有叶子证书），其他的数据集都包含PKCS#7文件。首先从文件中通过中间证书和TSA证书得到叶子证书，然后通过`extendedKeyUsage`关键词`Code Signing`找到代码签名证书。作者发现因为错误无法解析1989个叶子证书。最终从965114个二进制文件中找到了145582个不重复的叶子代码签名证书，去重和其中的两个自签名证书之后，这些证书从CA中合法签署。

![image](https://user-images.githubusercontent.com/40269368/159109872-57045d30-b44d-49c8-afa8-5c9e66a68129.png)

> D1数据集可以用于 撤销策略的趋势、没有CRL和OCSP的证书、不一致的CRL和OCSP响应和从OCSP中得到的未知或未授权的响应。

**Revocation information(D2).** CRL和OCSP存储在对应的扩展（CRLDistributionPoints和AuthorityInfoAccess）中。作者从145582个叶子签名证书中得到了CRL和OCSP信息，大多数（94.1%）证书都包含这两种，只有CRL的有5.3%,0.06%的只有OCSP。发现了413个CRL（不重复），CRL可能用于TLS。所以需要在`Censys.io`上找到它们的用途并排除用于其他用途的CRL，用于代码签名的有215个。有131个OCSP点。

> D2数据集用于检验有效撤销日期设置的问题、在CRL中暂存的证书和不再更新的CRL。

### 3.2 Revocation Publication Date List (D3)

CRL包含撤销证书的序列号、撤销日期和原因代码，其中撤销日期（Revocation date）代表的是有效撤销时间（effective revocation date, $t_r$），该字段决定了签名程序代码的有效性。CRL中的撤销信息不包含证书变得被撤销的时间（这个意思是证书真正被大家认为是被撤销的，也就是发布的时间）。

作者设计了一个系统`revocation publication date collection system`每天从CRL数据集收集撤销的序列号，来检测`revocation publication date`$t_p$，意思是证书被添加到CRL或者OCSP服务器中。这个信息可以用来评估撤销的延迟（从恶意的签名文件出现到CA撤销）。从215个CRL中，观察到2617个不重复的证书添加到CRL中。

> D3数据集可以用于检测撤销时延。

### 3.3 Binary Sample Information (D4-D6)

为了完成评估，仍然需要签名二进制文件的信息。例如，无效的撤销日期设置导致恶意软件仍然有效需要找到撤销证书签发的二进制文件，也需要信息来决定它们的恶意性以及签名日期。因此，作者收集了签名二进制文件的信息，从以下三个数据集中WINE，Symantec和VirusTotal.

**Worldwide Intelligence Network Environment(WINE).(D4)** 根据参与数据共享的1000万Symantec用户提供的数据，作者使用了`binary reputation data`，其中包含二进制文件的元数据。从其中得到了以下的信息

- 文件的SHA256 哈希值
- 服务端的时间戳
- 发布者的名称
- 代码签名证书得到的CA

但是证书的其他细节信息没有在WINE中提供（例如序列号和CRL），而且也不提供真正的二进制文件。

> D4数据集被用来检测撤销时间设置的问题。

**Symantec metadata telemetry. (D5)**  通过上述的系统从CRL中观察的撤销证书，作者也收到了二进制文件的元信息，这些文件由2617个Symantec的代码签名证书，通过序列号来标识受影响的二进制文件。这些信息与WINE类似，但比WINE更近期一些。数据包含哈希值、序列号和首次的时间戳。也给出了区分恶意软件的标识。作者可以识别出签名恶意软件所使用的证书。 

> D5数据集被用来评估实际使用中的恶意软件使用的签名证书，并用来检测撤销延迟。

**VirusTotal.(D6)**  前两个平台不包含真实的二进制文件，所以使用了VirusTotal来获取具体的二进制文件来做进一步的分析。该网站提供了服务通过63个不同的杀毒软件分析潜在的恶意二进制文件和URL。当有文件提交时，这些分析就开始了，而且报告会存储在数据库中。作者使用提供的API来收集以下信息：二进制文件的签名日期，将文件视为恶意软件的AV驱动数量以及第一次提交给VirusTotal的时间戳信息。VirusTotal也允许用户使用规则匹配，可以帮助用户获取特定类型的恶意软件，即VirusTotal Hunting，它使用YARA来定义规则。作者收集的内容是至少10个AV驱动认为文件有问题。从每个报告中，作者提取了SHA256哈希值、第一次提交时间**（为什么）**以及序列号。

> D6的数据用来评估恶意软件签名证书，以及检查撤销延迟。作者还用其提供的现在API来下载文件以获得CRL或OCSP信息。

### 3.4 CRL/OCSP Reachability History (D7)

**CRL reachability history.**作者在一个月内每天检查CRL的可访问性，如果不可访问，就将时间戳和失败原因记录到log中。

> D7数据集用来评估CRL的不可访问性。

**OCSP reachability history. **每30分钟测量一次可访问性。除了简单地`ping`操作，它还使用Openssl通过OCSP协议使用包含该OCSP点的证书来询问OCSP点（**为什么**）。如果无法访问，就记录同样的信息到log中。一个月内，运行了131个OCSP点。

> D7数据集用于评估OCSP的不可访问性。

## 4. Discovery of Potentially Compromised Certificates

撤销证书的原因有很多，是否撤销以及什么时候撤销证书是困难的。比如私钥被用于恶意行为等。作者保守估算了用于签发恶意软件的证书的数量，并且比较了从安全公司获得的证书来评估找到所有可能有问题的证书的困难性。当一个恶意软件被发现，这些信息需要到达撤销证书的实体，这个实体必须要把证书加入到CRL。后续需要分析撤销信息公之于众到证书出现在CRL的时延。

### 4.1 Mark-recapture Population Estimation  标记重捕技术估计数量

撤销过程从发现恶意软件中的证书开始，为了知道这个过程的有效性，在此需要回答第一个问题，即`how many certificates are used to sign malware in the wild?`。当前没有代码签名证书官方库，所以本文采用了`mark-recapture`分析法，原本用于评估野生动植物的数量。目标是估计一个难以直接观察到的种群的数量。$N$是用于签发恶意软件的证书的数量。该技术需要从种群中提取两次单独的样本，并进行替换，第一个取样得到了$n_1$个实体，这些实体被标记并放回原本的数据集，第二次取样得到$n_2$个实体，其中有$p$个实体带有先前的标记。即$p$是两次取样的交集，表示这些实体之前被捕获过了。估计的总数为：

$n_1/N=n_2/p$ 可以得到N的近似值。作者主要针对两个数据集采用了这种方法，Symantec和VirusTotal。认为每个数据集都是总的证书数量的一次取样。

**Assumptions and interpretation.**标记重捕方法需要对研究的种群做三个假设。

1. 种群的实体有同等的几率被捕获；但是流行软件公司的证书是有更高几率出现在数据集中。通过分别取两个时间段的数据集，另外就是一些证书是用于特定的攻击，这样N的估算会较低，所以本文中的估算可以说是一个下界。
2. 从数据集中的采样应该是独立的，也就是初始的取样不会影响后续的第二次取样，保证上述等式是成立的。但是安全公司会共享恶意软件源，这样第二次取样会更容易取到第一次取过的样。 **？？？这里是因为是两个公司会共享数据？**
3. 数据集应该是封闭的，即不会随着生老病死而波动，但是本文的证书是随着时间变化的。为了解决这个问题，作者每天分别估算$N$，`birth date`的时间是在Symantec看到时间戳和在VirusTotal提交的时间，这是他们加入数据集的时间。离开数据集的时间是它们的撤销发布时间$t_p$。这样CRL每日更新，数据集大约就是`closed`。

**Results.**下图展示了估算的内容，表明估算出来的值大概是观察到的2.74倍，所以即使是大型的安全公司也无法捕获到大部分可能有问题的证书。下图同样表明，估算的证书和新撤销的证书居然差不多，表明大量的证书是没有被发现的。但是，即使是所有证书都被发现且撤销了，这中间的延迟同样会带来很多问题。

![image](https://user-images.githubusercontent.com/40269368/159122040-ab9aec97-90a9-4924-98eb-190d03a2212e.png)

### 4.2 Revocation Delay

第二个问题，当发现签名的恶意软件时，相应的证书什么时候会被撤销？本文的系统得到了撤销发布时间，只关注已经被撤销的证书，接下来的挑战是找到发现这个恶意软件的证书的时间。通过对比分析D5数据集和收集到的撤销发布时间来找，并通过VT和AVClass来找到确切时间。从VirusTotal中找到了19053个样例，以及254个证书。对于每个证书取最早的检测时间$t_d$。撤销时延是$(t_p-t_d)$，$t_p$是添加到CRL中的时间。

**Results.**时延从1天到1553天，平均为171.4天即5.6个月，标准差324.9天（衡量波动），中位数38天。表明，CA没有及时收到信息，也没有遵循CAB的规定。所以即使过了5个月仍然可能遭受威胁。

## 5 Setting the Revocation Date

### 5.1 Problems in Revocation Date Setting

即使可以及时发现这些恶意证书，CA也必须确定一个合适的撤销时间来覆盖证书错误的整个时间。第三个问题，撤销时间设置的合适吗？$t_r$的时间是多少？hard or soft。尽量将$t_r$设置为最老的$t_m$。

通过D1，发现82.8%是soft的。

![image](https://user-images.githubusercontent.com/40269368/159123208-592955c6-74e9-4b1b-8a43-8e7af51e625f.png)

评估了多少CA错误设置了撤销日期，以及多少恶意软件在证书撤销后仍然有效。分别进行了评估和发现

- 5.1%
- 通过看数据集中的$t_m$来看是否小于$t_r$。



## 6 Dissemination of Revocation Information

第四个问题。

### 6.1 Enforcement in Windows

Soft-fail policy，即认为撤销的证书为没有签名的。

### 6.2 Unavailable Revocation Information

撤销状态应尽量是一直更新的，但是发现：

- 一些证书可能没有CRL或者OCSP。
- 一些CRL和OCSP无法访问

### 6.3 Mismanagement in CRLs and OCSPs



## 7 Limitation

- Data sets collection 
- 标记重捕技术的估计



## 8 Discussion

建议

- 公开化证书和二进制文件的信息
- 更好地散播撤销信息
- 更保守的Windows验证策略

## 9 Related Work

两个方面：找到滥用的代码签名PKI以及评估web PKI的撤销问题。

**Code signing PKI abuse.**大部分恶意的PE文件都是PUP文件，它们由CA合法签发的证书签名的。前人研究没有评估撤销发布日期的影响，作者分析了，另外还发现了其他的问题。

**Revocations problem in the Web’s PKI.**  撤销的及时性以及对撤销状态的检查，因为检查撤销状态的代价比较大。CRL和OCSP的可用性，特别是终端的可用性、正常运行时间和错误响应。

## 10 Conclusion

证书撤销仍然是当前抵抗代码签名滥用的主要防御方法，包含上文所说的三个方面，找到有问题的证书、在合理的时间撤销并将撤销信息散播出去。本文发现这个过程存在问题，而且这些安全问题会引入新的安全威胁。例如，CA平均要花费5.6个月的时间来撤销一个给恶意软件签名的证书，标记重捕技术(mark-recapture)评估的方法也展示出在实际中找到这些被滥用的证书是困难的。签名的有效性由撤销日期决定，但是CA可能设置了错误的撤销日期，导致证书撤销之后这个软件仍然有效。另外CRL和OCSP的部署不规范也可能导致攻击，作者发现客户端在很多情况下都不检查证书的撤销状态，比如说没有CRL或者OCSP点，无法访问这些信息，CRL不再更新了，或者撤销的证书被错误地从其中移除了，CRL和OCSP信息的不一致性或者未知、未授权的OCSP响应。